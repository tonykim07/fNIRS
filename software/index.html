<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .control-panel {
            display: flex;
            justify-content: space-between;
        }
        .control-section {
            width: 45%;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div class="control-section">
            <h3>Emitter Control</h3>
            <div>
                <label for="emitter_control_override_enable">Emitter Control Override Enable:</label>
                <input type="checkbox" id="emitter_control_override_enable" onchange="updateControlData()">
            </div>
            <div>
                <label for="emitter_control_state">Emitter Control State:</label>
                <select id="emitter_control_state" onchange="updateControlData()" disabled>
                    <option value="0">DISABLED</option>
                    <option value="1">IDLE</option>
                    <option value="2">DEFAULT_MODE</option>
                    <option value="3">USER_CONTROL</option>
                    <option value="4">CYCLING</option>
                    <option value="5">FULLY_ENABLED_940NM</option>
                    <option value="6">FULLY_ENABLED_660NM</option>
                </select>
            </div>
            <div id="emitter_pwm_controls" style="display: none;">
                <h4>Emitter PWM Control</h4>
                <div>
                    <label>PWM Control High:</label>
                    <div>
                        <input type="checkbox" id="emitter_15" onchange="updateControlData()"> 15
                        <input type="checkbox" id="emitter_14" onchange="updateControlData()"> 14
                        <input type="checkbox" id="emitter_13" onchange="updateControlData()"> 13
                        <input type="checkbox" id="emitter_12" onchange="updateControlData()"> 12
                        <input type="checkbox" id="emitter_11" onchange="updateControlData()"> 11
                        <input type="checkbox" id="emitter_10" onchange="updateControlData()"> 10
                        <input type="checkbox" id="emitter_9" onchange="updateControlData()"> 9
                        <input type="checkbox" id="emitter_8" onchange="updateControlData()"> 8
                    </div>
                </div>
                <div>
                    <label>PWM Control Low:</label>
                    <div>
                        <input type="checkbox" id="emitter_7" onchange="updateControlData()"> 7
                        <input type="checkbox" id="emitter_6" onchange="updateControlData()"> 6
                        <input type="checkbox" id="emitter_5" onchange="updateControlData()"> 5
                        <input type="checkbox" id="emitter_4" onchange="updateControlData()"> 4
                        <input type="checkbox" id="emitter_3" onchange="updateControlData()"> 3
                        <input type="checkbox" id="emitter_2" onchange="updateControlData()"> 2
                        <input type="checkbox" id="emitter_1" onchange="updateControlData()"> 1
                        <input type="checkbox" id="emitter_0" onchange="updateControlData()"> 0
                    </div>
                </div>
            </div>
        </div>
        <div class="control-section">
            <h3>MUX Control</h3>
            <div>
                <label for="mux_control_override_enable">MUX Control Override Enable:</label>
                <input type="checkbox" id="mux_control_override_enable" onchange="updateControlData()">
            </div>
            <div>
                <label for="mux_control_state">MUX Control State:</label>
                <select id="mux_control_state" onchange="updateControlData()" disabled>
                    <option value="0">MUX Disabled</option>
                    <option value="1">MUX Channel 1</option>
                    <option value="2">MUX Channel 2</option>
                    <option value="3">MUX Channel 3</option>
                </select>
            </div>
        </div>
    </div>
    <div id="brain-mesh-graph" style="display: inline-block; width: 45%;"></div>
    <div id="stacked-activation-graph" style="display: inline-block; width: 45%;"></div>

    <script>
        let controlData = {
            emitter_control_override_enable: 0,
            emitter_control_state: 0,
            emitter_pwm_control_h: 0,
            emitter_pwm_control_l: 0,
            mux_control_override_enable: 0,
            mux_control_state: 0
        };

        function updateControlData() {
            controlData.emitter_control_override_enable = document.getElementById('emitter_control_override_enable').checked ? 1 : 0;
            controlData.emitter_control_state = parseInt(document.getElementById('emitter_control_state').value);
            controlData.emitter_pwm_control_h = getPwmControlValue('h');
            controlData.emitter_pwm_control_l = getPwmControlValue('l');
            controlData.mux_control_override_enable = document.getElementById('mux_control_override_enable').checked ? 1 : 0;
            controlData.mux_control_state = parseInt(document.getElementById('mux_control_state').value);

            $.ajax({
                url: '/update_control_data',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(controlData),
                success: function(response) {
                    console.log('Control data updated:', response);
                }
            });

            updateUI();
        }

        function getPwmControlValue(type) {
            let value = 0;
            for (let i = 0; i < 8; i++) {
                const index = type === 'h' ? 15 - i : 7 - i;
                const checkbox = document.getElementById(`emitter_${index}`);
                if (checkbox && checkbox.checked) {
                    value |= (1 << i);
                }
            }
            return value;
        }

        function updateUI() {
            const emitterOverrideEnabled = document.getElementById('emitter_control_override_enable').checked;
            const muxOverrideEnabled = document.getElementById('mux_control_override_enable').checked;
            const emitterControlState = parseInt(document.getElementById('emitter_control_state').value);

            document.getElementById('emitter_control_state').disabled = !emitterOverrideEnabled;
            document.getElementById('mux_control_state').disabled = !muxOverrideEnabled;
            document.getElementById('emitter_pwm_controls').style.display = (emitterControlState === 3 && emitterOverrideEnabled) ? 'block' : 'none';
        }

        function updateGraphs() {
            $.getJSON('/update_graphs', function(data) {
                console.log("Updating graphs with data:", data);
                if (data.brain_mesh && data.stacked_activation) {
                    Plotly.react('brain-mesh-graph', JSON.parse(data.brain_mesh).data, JSON.parse(data.brain_mesh).layout);
                    Plotly.react('stacked-activation-graph', JSON.parse(data.stacked_activation).data, JSON.parse(data.stacked_activation).layout);
                }
            }).always(function() {
                // Schedule the next update 1 second after this one finishes
                setTimeout(updateGraphs, 1000);
            });
        }

        updateGraphs();

    </script>
</body>
</html>