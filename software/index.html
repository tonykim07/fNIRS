<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>fNIRS Data Visualization</title>
  <!-- Load Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <!-- Load Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- Load jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* Global Styles */
    body {
      background-color: #eef2f7;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      color: #333;
    }

    h1,
    h3 {
      color: #004085;
    }

    .container {
      max-width: 1500px;
      padding-left: 10px;
      padding-right: 10px;
    }

    /* Card Styles */
    .card {
      margin-bottom: 20px;
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card-header {
      background-color: #004085;
      color: #fff;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      text-align: center;
      font-size: 1.25rem;
    }

    .card-body {
      background-color: #fff;
      padding: 20px;
    }

    /* Graph Container Styles */
    .graph-container {
      padding: 15px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .btn-custom {
      background-color: white;
      color: #004085;
      border: 2px solid #004085;
    }

    .btn-custom:hover,
    .btn-custom:focus,
    .btn-custom:active {
      background-color: #004085;
      color: white;
    }

    .btn-custom.active {
      background-color: #004085;
      color: white;
    }

    /* Brain Mesh Container */
    #brainMeshContainer {
      width: 100%;
      height: 800px;
    }
  </style>
</head>

<body>
  <div class="container my-4">
    <!-- Page Header -->
    <div class="text-center mb-4">
      <h1>fNIRS Data Visualization</h1>
    </div>

    <div class="row">
      <!-- Left Column: Brain Mesh -->
      <div class="col-md-8">
        <div class="card mb-4">
          <div class="card-header">3D Brain Mesh with Sensor Nodes</div>
          <div class="card-body">
            <div id="brainMeshContainer"></div>
          </div>
        </div>
      </div>

      <!-- Right Column: Control Panels -->
      <div class="col-md-4">
        <!-- Sensor Group Buttons Panel -->
        <div class="card mb-4">
          <div class="card-header">Sensor Group Mappings</div>
          <div class="card-body">
            <div class="row">
              <div class="col-6 custom-btn-group" role="group">
                <button type="button" class="btn btn-custom btn-sm btn-block mb-2">Group 1</button>
                <button type="button" class="btn btn-custom btn-sm btn-block mb-2">Group 2</button>
                <button type="button" class="btn btn-custom btn-sm btn-block mb-2">Group 3</button>
                <button type="button" class="btn btn-custom btn-sm btn-block">Group 4</button>
              </div>
              <div class="col-6 custom-btn-group" role="group">
                <button type="button" class="btn btn-custom btn-sm btn-block mb-2">Group 5</button>
                <button type="button" class="btn btn-custom btn-sm btn-block mb-2">Group 6</button>
                <button type="button" class="btn btn-custom btn-sm btn-block mb-2">Group 7</button>
                <button type="button" class="btn btn-custom btn-sm btn-block">Group 8</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Control Panel: MUX Control (Top) and Emitter Control (Bottom) -->
        <div class="card">
          <div class="card-header">Control Panel</div>
          <div class="card-body">
            <!-- MUX Control Section -->
            <div class="mb-4">
              <h3>MUX Control</h3>
              <div class="mb-2">
                <label for="mux_control_override_enable">Override Enable:</label>
                <input type="checkbox" id="mux_control_override_enable" onchange="updateControlData()">
              </div>
              <div class="mb-2">
                <label for="mux_control_state">Control State:</label>
                <select id="mux_control_state" onchange="updateControlData()" disabled>
                  <option value="0">MUX Disabled</option>
                  <option value="1">MUX Channel 1</option>
                  <option value="2">MUX Channel 2</option>
                  <option value="3">MUX Channel 3</option>
                </select>
              </div>
            </div>

            <!-- Emitter Control Section -->
            <div>
              <h3>Emitter Control</h3>
              <div class="mb-2">
                <label for="emitter_control_override_enable">Override Enable:</label>
                <input type="checkbox" id="emitter_control_override_enable" onchange="updateControlData()">
              </div>
              <div class="mb-2">
                <label for="emitter_control_state">Control State:</label>
                <select id="emitter_control_state" onchange="updateControlData()" disabled>
                  <option value="0">DISABLED</option>
                  <option value="1">IDLE</option>
                  <option value="2">DEFAULT_MODE</option>
                  <option value="3">USER_CONTROL</option>
                  <option value="4">CYCLING</option>
                  <option value="5">FULLY_ENABLED_940NM</option>
                  <option value="6">FULLY_ENABLED_660NM</option>
                </select>
              </div>
              <!-- Emitter PWM Control Table -->
              <div id="emitter_pwm_controls" style="display: none;">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Emitter</th>
                      <th>940nm</th>
                      <th>660nm</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Emitter 0</td>
                      <td><input type="checkbox" id="emitter_0_940" onchange="updateControlData()"></td>
                      <td><input type="checkbox" id="emitter_0_660" onchange="updateControlData()"></td>
                    </tr>
                    <tr>
                      <td>Emitter 1</td>
                      <td><input type="checkbox" id="emitter_1_940" onchange="updateControlData()"></td>
                      <td><input type="checkbox" id="emitter_1_660" onchange="updateControlData()"></td>
                    </tr>
                    <tr>
                      <td>Emitter 2</td>
                      <td><input type="checkbox" id="emitter_2_940" onchange="updateControlData()"></td>
                      <td><input type="checkbox" id="emitter_2_660" onchange="updateControlData()"></td>
                    </tr>
                    <tr>
                      <td>Emitter 3</td>
                      <td><input type="checkbox" id="emitter_3_940" onchange="updateControlData()"></td>
                      <td><input type="checkbox" id="emitter_3_660" onchange="updateControlData()"></td>
                    </tr>
                    <tr>
                      <td>Emitter 4</td>
                      <td><input type="checkbox" id="emitter_4_940" onchange="updateControlData()"></td>
                      <td><input type="checkbox" id="emitter_4_660" onchange="updateControlData()"></td>
                    </tr>
                    <tr>
                      <td>Emitter 5</td>
                      <td><input type="checkbox" id="emitter_5_940" onchange="updateControlData()"></td>
                      <td><input type="checkbox" id="emitter_5_660" onchange="updateControlData()"></td>
                    </tr>
                    <tr>
                      <td>Emitter 6</td>
                      <td><input type="checkbox" id="emitter_6_940" onchange="updateControlData()"></td>
                      <td><input type="checkbox" id="emitter_6_660" onchange="updateControlData()"></td>
                    </tr>
                    <tr>
                      <td>Emitter 7</td>
                      <td><input type="checkbox" id="emitter_7_940" onchange="updateControlData()"></td>
                      <td><input type="checkbox" id="emitter_7_660" onchange="updateControlData()"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div> <!-- End Card Body for Control Panel -->
        </div> <!-- End Control Panel Card -->
      </div> <!-- End Right Column -->
    </div> <!-- End Row -->

    <!-- Expanded/Collapsed Sensor Group Charts (existing code remains) -->
    <div class="text-center mb-3">
      <button id="toggleMode" class="btn btn-primary">Switch to Collapsed Mode</button>
    </div>

    <!-- Expanded Mode: Grid Layout for Sensor Group Charts -->
    <div id="expanded-container">
      <div class="row">
        <div class="col-md-6">
          <div class="card graph-container">
            <div class="card-header text-center">Sensor Group 1</div>
            <div class="card-body p-0">
              <div id="group1" style="height: 400px;"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card graph-container">
            <div class="card-header text-center">Sensor Group 2</div>
            <div class="card-body p-0">
              <div id="group2" style="height: 400px;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="card graph-container">
            <div class="card-header text-center">Sensor Group 3</div>
            <div class="card-body p-0">
              <div id="group3" style="height: 400px;"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card graph-container">
            <div class="card-header text-center">Sensor Group 4</div>
            <div class="card-body p-0">
              <div id="group4" style="height: 400px;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="card graph-container">
            <div class="card-header text-center">Sensor Group 5</div>
            <div class="card-body p-0">
              <div id="group5" style="height: 400px;"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card graph-container">
            <div class="card-header text-center">Sensor Group 6</div>
            <div class="card-body p-0">
              <div id="group6" style="height: 400px;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="card graph-container">
            <div class="card-header text-center">Sensor Group 7</div>
            <div class="card-body p-0">
              <div id="group7" style="height: 400px;"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card graph-container">
            <div class="card-header text-center">Sensor Group 8</div>
            <div class="card-body p-0">
              <div id="group8" style="height: 400px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Collapsed Mode: Tabbed Layout for Sensor Group Charts -->
    <div id="collapsed-container" style="display: none;">
      <ul class="nav nav-tabs" id="groupTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="tab1-tab" data-toggle="tab" href="#tab1" role="tab">Group 1</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab2-tab" data-toggle="tab" href="#tab2" role="tab">Group 2</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab3-tab" data-toggle="tab" href="#tab3" role="tab">Group 3</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab4-tab" data-toggle="tab" href="#tab4" role="tab">Group 4</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab5-tab" data-toggle="tab" href="#tab5" role="tab">Group 5</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab6-tab" data-toggle="tab" href="#tab6" role="tab">Group 6</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab7-tab" data-toggle="tab" href="#tab7" role="tab">Group 7</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab8-tab" data-toggle="tab" href="#tab8" role="tab">Group 8</a>
        </li>
      </ul>
      <div class="tab-content" id="groupTabsContent">
        <div class="tab-pane fade show active graph-container" id="tab1" role="tabpanel" style="height: 400px;"></div>
        <div class="tab-pane fade graph-container" id="tab2" role="tabpanel" style="height: 400px;"></div>
        <div class="tab-pane fade graph-container" id="tab3" role="tabpanel" style="height: 400px;"></div>
        <div class="tab-pane fade graph-container" id="tab4" role="tabpanel" style="height: 400px;"></div>
        <div class="tab-pane fade graph-container" id="tab5" role="tabpanel" style="height: 400px;"></div>
        <div class="tab-pane fade graph-container" id="tab6" role="tabpanel" style="height: 400px;"></div>
        <div class="tab-pane fade graph-container" id="tab7" role="tabpanel" style="height: 400px;"></div>
        <div class="tab-pane fade graph-container" id="tab8" role="tabpanel" style="height: 400px;"></div>
      </div>
    </div>
  </div>

  <!-- Load Bootstrap JS and dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

  <script>
    // LED green color; adjust as needed.
    const LED_GREEN = "#39FF14";
    const WHITE = "white";

    var currentGroup = null;  // global variable to store the selected group
    var currentCamera = null; // Global variable to store current camera settings

    // Attach a listener to capture camera changes.
    // Using Plotly's built-in event handler.
    function attachCameraListener() {
      var brainDiv = document.getElementById("brainMeshContainer");
      if (brainDiv) {
        // Remove any previously attached listener first (if needed)
        // Then attach the listener.
        brainDiv.on('plotly_relayout', function (eventData) {
          if (eventData['scene.camera']) {
            currentCamera = eventData['scene.camera'];
            // Debug log:
            console.log("Camera updated:", currentCamera);
          }
        });
      }
    }

    // This function updates the emitter capsule colors based on PWM checkbox states.
    function updateEmitterColors() {
      // We assume you have 8 emitters.
      var emitterColors = [];
      for (var i = 0; i < 8; i++) {
        // Check if either wavelength control for emitter i is checked.
        var isActive = $("#emitter_" + i + "_940").is(":checked") || $("#emitter_" + i + "_660").is(":checked");
        emitterColors.push(isActive ? LED_GREEN : WHITE);
      }

      // Get the brain mesh Plotly div.
      var brainDiv = document.getElementById("brainMeshContainer");
      if (!brainDiv || !brainDiv.data) return;

      // Identify the emitter traces.
      // (We assume emitter traces were added in the same order as emitter_positions.)
      var emitterTraceIndices = [];
      var count = 0;
      for (var i = 0; i < brainDiv.data.length; i++) {
        if (brainDiv.data[i].name === "Emitter") {
          emitterTraceIndices.push(i);
          count++;
        }
      }
      // If the number of emitter traces doesn't match, log a warning.
      if (emitterTraceIndices.length !== emitterColors.length) {
        console.warn("Emitter trace count and emitter color count do not match!");
      }

      // Update each emitter trace's color.
      emitterTraceIndices.forEach(function (traceIndex, idx) {
        Plotly.restyle(brainDiv, { 'color': [emitterColors[idx]] }, traceIndex);
      });
    }

    $(document).ready(function () {
      // Attach a click handler to each sensor group button.
      $(".custom-btn-group button").click(function () {
        // Extract the group number from the button text (assumes format "Sensor Group X").
        var buttonText = $(this).text().trim();
        var groupId = parseInt(buttonText.split(" ")[1]);

        // Set the global variable to persist the selection.
        currentGroup = groupId;

        // Update button styles so only one appears active
        $(".custom-btn-group button").removeClass("active");
        $(this).addClass("active");

        // Call the endpoint to get the updated brain mesh with the selected group highlighted.
        $.getJSON("/select_group/" + groupId, function (data) {
          if (data.brain_mesh) {
            const brainFig = JSON.parse(data.brain_mesh);
            // If a camera setting exists, reapply it.
            if (currentCamera) {
              brainFig.layout.scene.camera = currentCamera;
            }
            // Use Plotly.react and then, once finished, reapply the camera.
            Plotly.react("brainMeshContainer", brainFig.data, brainFig.layout).then(function () {
              if (currentCamera) {
                Plotly.relayout("brainMeshContainer", { "scene.camera": currentCamera });
              }
              attachCameraListener();
            });
          }
        });
      });
    });

    // Emitter & MUX control logic
    let controlData = {
      emitter_control_override_enable: 0,
      emitter_control_state: 0,
      emitter_pwm_control_h: 0,
      emitter_pwm_control_l: 0,
      mux_control_override_enable: 0,
      mux_control_state: 0
    };

    function updateControlData() {
      controlData.emitter_control_override_enable = document.getElementById('emitter_control_override_enable').checked ? 1 : 0;
      controlData.emitter_control_state = parseInt(document.getElementById('emitter_control_state').value);
      controlData.emitter_pwm_control_h = getPwmControlValue('h');
      controlData.emitter_pwm_control_l = getPwmControlValue('l');
      controlData.mux_control_override_enable = document.getElementById('mux_control_override_enable').checked ? 1 : 0;
      controlData.mux_control_state = parseInt(document.getElementById('mux_control_state').value);

      $.ajax({
        url: '/update_control_data',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(controlData),
        success: function (response) {
          console.log('Control data updated:', response);
        }
      });

      updateUI();
      updateEmitterColors();
    }

    function getPwmControlValue(type) {
      let value = 0;
      if (type === 'l') {
        // For lower register: channels 0-7 come from emitters 0-3.
        for (let emitter = 0; emitter < 4; emitter++) {
          // 660nm channel (even channel: 2*emitter)
          const checkbox660 = document.getElementById(`emitter_${emitter}_660`);
          if (checkbox660 && checkbox660.checked) {
            value |= (1 << (2 * emitter));
          }
          // 940nm channel (odd channel: 2*emitter + 1)
          const checkbox940 = document.getElementById(`emitter_${emitter}_940`);
          if (checkbox940 && checkbox940.checked) {
            value |= (1 << (2 * emitter + 1));
          }
        }
      } else if (type === 'h') {
        // For higher register: channels 8-15 come from emitters 4-7.
        // We map these channels to bit positions 0-7 in the high register.
        for (let emitter = 4; emitter < 8; emitter++) {
          // Determine bit position in the high register for emitter X.
          let bitPos = (emitter - 4) * 2;
          const checkbox660 = document.getElementById(`emitter_${emitter}_660`);
          if (checkbox660 && checkbox660.checked) {
            value |= (1 << bitPos);
          }
          const checkbox940 = document.getElementById(`emitter_${emitter}_940`);
          if (checkbox940 && checkbox940.checked) {
            value |= (1 << (bitPos + 1));
          }
        }
      }
      return value;
    }


    function updateUI() {
      const emitterOverrideEnabled = document.getElementById('emitter_control_override_enable').checked;
      const muxOverrideEnabled = document.getElementById('mux_control_override_enable').checked;
      const emitterControlState = parseInt(document.getElementById('emitter_control_state').value);

      document.getElementById('emitter_control_state').disabled = !emitterOverrideEnabled;
      document.getElementById('mux_control_state').disabled = !muxOverrideEnabled;
      document.getElementById('emitter_pwm_controls').style.display = (emitterControlState === 3 && emitterOverrideEnabled) ? 'block' : 'none';
    }

    // Function to update brain mesh and sensor charts
    function updateGraphs() {
      var endpoint = currentGroup !== null ? '/select_group/' + currentGroup : '/update_graphs';
      $.getJSON(endpoint, function (data) {
        // Update brain mesh
        if (data.brain_mesh) {
          const brainFig = JSON.parse(data.brain_mesh);
          var brainDiv = document.getElementById("brainMeshContainer");
          // Use currentCamera if available, otherwise try to get the current camera from the existing layout.
          if (currentCamera) {
            brainFig.layout.scene.camera = currentCamera;
          } else if (brainDiv && brainDiv._fullLayout && brainDiv._fullLayout.scene && brainDiv._fullLayout.scene.camera) {
            brainFig.layout.scene.camera = brainDiv._fullLayout.scene.camera;
          }
          Plotly.react("brainMeshContainer", brainFig.data, brainFig.layout).then(function () {
            if (currentCamera) {
              Plotly.relayout("brainMeshContainer", { "scene.camera": currentCamera });
            }
            attachCameraListener();
            updateEmitterColors();
          });
        }
        // Update expanded sensor charts
        if (data.grouped_activation) {
          for (let i = 1; i <= 8; i++) {
            if (data.grouped_activation[`group${i}`]) {
              const fig = JSON.parse(data.grouped_activation[`group${i}`]);
              Plotly.react(`group${i}`, fig.data, fig.layout);
            }
          }
          // Update collapsed (tabbed) sensor charts
          for (let i = 1; i <= 8; i++) {
            if (data.grouped_activation[`group${i}`]) {
              const fig = JSON.parse(data.grouped_activation[`group${i}`]);
              Plotly.react(`tab${i}`, fig.data, fig.layout);
            }
          }
        } else if (data.stacked_activation) {
          // Fallback example
          const fig = JSON.parse(data.stacked_activation);
          Plotly.react('group1', fig.data, fig.layout);
          Plotly.react('tab1', fig.data, fig.layout);
        }
      }).always(function () {
        setTimeout(updateGraphs, 1000);
      });
    }

    // Toggle between expanded and collapsed modes
    document.getElementById('toggleMode').addEventListener('click', function () {
      const expanded = document.getElementById('expanded-container');
      const collapsed = document.getElementById('collapsed-container');
      if (expanded.style.display !== 'none') {
        expanded.style.display = 'none';
        collapsed.style.display = 'block';
        this.textContent = 'Switch to Expanded Mode';
      } else {
        expanded.style.display = 'block';
        collapsed.style.display = 'none';
        this.textContent = 'Switch to Collapsed Mode';
      }
    });

    // Initial rendering of graphs and control UI
    updateGraphs();
  </script>
</body>

</html>