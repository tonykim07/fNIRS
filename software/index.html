<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div>
        <label for="emitter_control_override_enable">Emitter Control Override Enable:</label>
        <input type="checkbox" id="emitter_control_override_enable" onchange="updateControlData()">
    </div>
    <div>
        <label for="emitter_control_state">Emitter Control State:</label>
        <select id="emitter_control_state" onchange="updateControlData()">
            <option value="0">DISABLED</option>
            <option value="1">IDLE</option>
            <option value="2">DEFAULT_MODE</option>
            <option value="3">USER_CONTROL</option>
            <option value="4">CYCLING</option>
            <option value="5">FULLY_ENABLED_940NM</option>
            <option value="6">FULLY_ENABLED_660NM</option>
        </select>
    </div>
    <div>
        <label for="emitter_pwm_control_h">Emitter PWM Control High:</label>
        <input type="text" id="emitter_pwm_control_h" value="0" onchange="updateControlData()">
    </div>
    <div>
        <label for="emitter_pwm_control_l">Emitter PWM Control Low:</label>
        <input type="text" id="emitter_pwm_control_l" value="0" onchange="updateControlData()">
    </div>
    <div>
        <label for="mux_control_override_enable">MUX Control Override Enable:</label>
        <input type="checkbox" id="mux_control_override_enable" onchange="updateControlData()">
    </div>
    <div>
        <label for="mux_control_state">MUX Control State:</label>
        <select id="mux_control_state" onchange="updateControlData()">
            <option value="0">MUX Disabled</option>
            <option value="1">MUX Channel 1</option>
            <option value="2">MUX Channel 2</option>
            <option value="3">MUX Channel 3</option>
        </select>
    </div>
    <div id="brain-mesh-graph" style="display: inline-block; width: 45%;"></div>
    <div id="stacked-activation-graph" style="display: inline-block; width: 45%;"></div>

    <script>
        let controlData = {
            emitter_control_override_enable: 0,
            emitter_control_state: 0,
            emitter_pwm_control_h: 0,
            emitter_pwm_control_l: 0,
            mux_control_override_enable: 0,
            mux_control_state: 0
        };

        function updateControlData() {
            controlData.emitter_control_override_enable = document.getElementById('emitter_control_override_enable').checked ? 1 : 0;
            controlData.emitter_control_state = parseInt(document.getElementById('emitter_control_state').value);
            controlData.emitter_pwm_control_h = parseInt(document.getElementById('emitter_pwm_control_h').value);
            controlData.emitter_pwm_control_l = parseInt(document.getElementById('emitter_pwm_control_l').value);
            controlData.mux_control_override_enable = document.getElementById('mux_control_override_enable').checked ? 1 : 0;
            controlData.mux_control_state = parseInt(document.getElementById('mux_control_state').value);

            $.ajax({
                url: '/update_control_data',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(controlData),
                success: function(response) {
                    console.log('Control data updated:', response);
                }
            });
        }

        function updateGraphs() {
            $.getJSON('/update_graphs', function(data) {
                console.log("Updating graphs with data:", data);
                if (data.brain_mesh && data.stacked_activation) {
                    Plotly.react('brain-mesh-graph', JSON.parse(data.brain_mesh).data, JSON.parse(data.brain_mesh).layout);
                    Plotly.react('stacked-activation-graph', JSON.parse(data.stacked_activation).data, JSON.parse(data.stacked_activation).layout);
                }
            });
        }

        setInterval(updateGraphs, 1000);  // Update every 1000ms
    </script>
</body>
</html>